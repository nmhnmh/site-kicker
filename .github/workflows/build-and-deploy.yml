name: build and deploy

on:
  push:
    tags:
      - '*.*.*'

jobs:

  Linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Get tag
      id: tag
      run: |
        echo ::set-env name=tag::${GITHUB_REF#refs/tags/}
    - name: Publish to pypi.org
      run: |
        poetry install
        poetry build
        poetry publish -u __token__ -p ${PYPI_TOKEN}
    - name: Publish to Docker hub
      run: |
      docker login --username nmhnmh --password ${DOCKER_HUB_TOKEN}
      docker build . -t sitekicker:latest
      docker tag sitekicker:latest sitekicker:${tag}
      docker push sitekicker:latest
      docker push sitekicker:${tag}